import { atom, selector, DefaultValue, useRecoilValue, useRecoilState, useSetRecoilState, useResetRecoilState } from 'recoil';
import { isEqual, debounce } from 'lodash';
import { v4 } from 'uuid';
import { createContext, useContext, useMemo, useEffect, useCallback, useRef, useState } from 'react';
import ee from 'jwt-decode';
import Zt from 'swr';
import ue from 'socket.io-client';
export { Socket } from 'socket.io-client';

var Et=s=>{let t={},e=new Date,n=new Date;n.setDate(e.getDate()-1);let o=new Date;o.setDate(e.getDate()-7);let r=new Date;return r.setDate(e.getDate()-30),s.forEach(c=>{let a=new Date(c.createdAt),g=a.toDateString()===e.toDateString(),m=a.toDateString()===n.toDateString(),f=a>=o,y=a>=r,S;g?S="Today":m?S="Yesterday":f?S="Previous 7 days":y?S="Previous 30 days":S=a.toLocaleString("default",{month:"long",year:"numeric"}).split(" ").slice(0,1).join(" "),t[S]||(t[S]=[]),t[S].push(c);}),t};var st=atom({key:"ThreadIdToResume",default:void 0}),Pt=atom({key:"ChatProfile",default:void 0}),Dt=atom({key:"SessionId",default:v4()}),et=selector({key:"SessionIdSelector",get:({get:s})=>s(Dt),set:({set:s},t)=>s(Dt,t instanceof DefaultValue?v4():t)}),B=atom({key:"Session",dangerouslyAllowMutability:!0,default:void 0}),V=atom({key:"Actions",default:[]}),j=atom({key:"Messages",dangerouslyAllowMutability:!0,default:[]}),ot=atom({key:"TokenCount",default:0}),$=atom({key:"Loading",default:!1}),H=atom({key:"AskUser",default:void 0}),rt=atom({key:"CallFn",default:void 0}),U=atom({key:"ChatSettings",default:[]}),mt=selector({key:"ChatSettingsValue/Default",get:({get:s})=>s(U).reduce((e,n)=>(e[n.id]=n.initial,e),{})}),O=atom({key:"ChatSettingsValue",default:mt}),q=atom({key:"DisplayElements",default:[]}),K=atom({key:"TasklistElements",default:[]}),W=atom({key:"FirstUserInteraction",default:void 0}),z=atom({key:"AccessToken",default:void 0}),Ut=atom({key:"User",default:null}),vt=atom({key:"ChainlitConfig",default:void 0}),Lt=atom({key:"ThreadHistory",default:{threads:void 0,currentThreadId:void 0,timeGroupedThreads:void 0,pageInfo:void 0},effects:[({setSelf:s,onSet:t})=>{t((e,n)=>{let o=e?.timeGroupedThreads;e?.threads&&!isEqual(e.threads,n?.timeGroupedThreads)&&(o=Et(e.threads)),s({...e,timeGroupedThreads:o});});}]}),Bt=atom({key:"SideView",default:void 0}),G=atom({key:"CurrentThreadId",default:void 0});var be=()=>{let s=useRecoilValue($),t=useRecoilValue(q),e=useRecoilValue(K),n=useRecoilValue(V),o=useRecoilValue(B),r=useRecoilValue(H),c=useRecoilValue(rt),a=useRecoilValue(U),g=useRecoilValue(O),m=useRecoilValue(mt),f=o?.socket.connected&&!o?.error,y=!f||s||r?.spec.type==="file"||r?.spec.type==="action";return {actions:n,askUser:r,callFn:c,chatSettingsDefaultValue:m,chatSettingsInputs:a,chatSettingsValue:g,connected:f,disabled:y,elements:t,error:o?.error,loading:s,tasklists:e}};var we=s=>{let t=[];for(let e of s)t=D(t,e);return t},Re=(s,t)=>{if(s.length-1===t)return !0;for(let e=t+1;e<s.length;e++)if(!s[e].streaming)return !1;return !0},D=(s,t)=>{let e=["assistant_message","user_message"],n=[...e,"tool"],o=e.includes(t.type),r=n.includes(t.type),c=!t.parentId;if(c&&!r)return s;let a=c?void 0:ht(s,t.parentId),g=(c||a?.type!=="assistant_message")&&t.type==="tool";if(at(s,t.id))return ct(s,t.id,t);if(g){let m=s.length>0?s[s.length-1]:void 0,f=m?.type==="assistant_message"&&m?.id.startsWith("wrap_");return m&&f?[...s.slice(0,s.length-1),{...m,steps:[...m.steps||[],t]}]:[...s,{...t,name:"",input:"",output:"",id:"wrap_"+t.id,type:"assistant_message",steps:[t]}]}else return !o&&"parentId"in t&&t.parentId?jt(s,t.parentId,t):"indent"in t&&t.indent&&t.indent>0?Vt(s,t.indent,t):[...s,t]},Vt=(s,t,e,n=0)=>{let o=[...s];if(o.length===0)return [...o,e];{let r=o.length-1,c=o[r];return c.steps=c.steps||[],n+1===t?(c.steps=[...c.steps,e],o[r]={...c},o):(c.steps=Vt(c.steps,t,e,n+1),o[r]={...c},o)}},jt=(s,t,e)=>{let n=[...s];for(let o=0;o<n.length;o++){let r=n[o];isEqual(r.id,t)?(r.steps=r.steps?[...r.steps,e]:[e],n[o]={...r}):at(n,t)&&r.steps&&(r.steps=jt(r.steps,t,e),n[o]={...r});}return n},ht=(s,t)=>{for(let e of s){if(isEqual(e.id,t))return e;if(e.steps&&e.steps.length>0){let n=ht(e.steps,t);if(n)return n}}},at=(s,t)=>ht(s,t)!==void 0,ct=(s,t,e)=>{let n=[...s];for(let o=0;o<n.length;o++){let r=n[o];isEqual(r.id,t)?n[o]={steps:r.steps,...e}:at(n,t)&&r.steps&&(r.steps=ct(r.steps,t,e),n[o]={...r});}return n},St=(s,t)=>{let e=[...s];for(let n=0;n<e.length;n++){let o=e[n];o.id===t?e=[...e.slice(0,n),...e.slice(n+1)]:at(e,t)&&o.steps&&(o.steps=St(o.steps,t),e[n]={...o});}return e},It=(s,t,e,n,o)=>{let r=[...s];for(let c=0;c<r.length;c++){let a=r[c];isEqual(a.id,t)?("content"in a&&a.content!==void 0?n?a.content=e:a.content+=e:o?"input"in a&&a.input!==void 0&&(n?a.input=e:a.input+=e):"output"in a&&a.output!==void 0&&(n?a.output=e:a.output+=e),r[c]={...a}):a.steps&&(a.steps=It(a.steps,t,e,n,o),r[c]={...a});}return r};var kt="token";function yt(){try{return localStorage.getItem(kt)}catch{return}}function $t(s){try{return localStorage.setItem(kt,s)}catch{return}}function lt(){try{return localStorage.removeItem(kt)}catch{return}}var te=async(s,t,e)=>(await s.get(t,e))?.json();function dt(s,{token:t,...e}={}){let n=useContext(P),o=useRecoilValue(z);o=t||o;let r=useMemo(()=>([a,g])=>te(n,a,g),[n]),c=useMemo(()=>s?[s,o]:null,[s,o]);return Zt(c,r,e)}var qt=()=>{let s=useContext(P),{data:t,isLoading:e}=dt("/auth/config"),[n,o]=useRecoilState(z),r=useSetRecoilState(Lt),[c,a]=useRecoilState(Ut),g=!!(!e&&t),m=async()=>{await s.logout(),a(null),lt(),o(""),r(void 0);},f=S=>{if(!S){m();return}try{let{exp:w,...F}=ee(S);$t(S),o(`Bearer ${S}`),a(F);}catch(w){console.error("Invalid token, clearing token from local storage","error:",w),m();}};useEffect(()=>{if(!c&&yt()){f(yt());return}},[]);let y=!!n;return t&&!t.requireLogin?{data:t,user:null,isReady:g,isAuthenticated:!0,accessToken:"",logout:()=>{},setAccessToken:()=>{}}:{data:t,user:c,isAuthenticated:y,isReady:g,accessToken:n,logout:m,setAccessToken:f}};var ut=class extends Error{constructor(e,n){super(e);this.detail=n;}toString(){return this.detail?`${this.message}: ${this.detail}`:this.message}},Tt=class{constructor(t,e,n,o){this.httpEndpoint=t;this.type=e;this.on401=n;this.onError=o;}buildEndpoint(t){return this.httpEndpoint.endsWith("/")?`${this.httpEndpoint.slice(0,-1)}${t}`:`${this.httpEndpoint}${t}`}checkToken(t){let e="Bearer ";return t.startsWith(e)?t:e+t}async fetch(t,e,n,o,r){try{let c={};n&&(c.Authorization=this.checkToken(n));let a;o instanceof FormData?a=o:(c["Content-Type"]="application/json",a=o?JSON.stringify(o):null);let g=await fetch(this.buildEndpoint(e),{method:t,headers:c,signal:r,body:a});if(!g.ok){let m=await g.json();throw g.status===401&&this.on401&&(lt(),this.on401()),new ut(g.statusText,m.detail)}return g}catch(c){throw c instanceof ut&&this.onError&&this.onError(c),console.error(c),c}}async get(t,e){return await this.fetch("GET",t,e)}async post(t,e,n,o){return await this.fetch("POST",t,n,e,o)}async put(t,e,n){return await this.fetch("PUT",t,n,e)}async patch(t,e,n){return await this.fetch("PATCH",t,n,e)}async delete(t,e,n){return await this.fetch("DELETE",t,n,e)}},ft=class extends Tt{async headerAuth(){return (await this.post("/auth/header",{})).json()}async passwordAuth(t){return (await this.post("/login",t)).json()}async logout(){return (await this.post("/logout",{})).json()}async setFeedback(t,e){return (await this.put("/feedback",{feedback:t},e)).json()}async deleteFeedback(t,e){return (await this.delete("/feedback",{feedbackId:t},e)).json()}async listThreads(t,e,n){return (await this.post("/project/threads",{pagination:t,filter:e},n)).json()}async deleteThread(t,e){return (await this.delete("/project/thread",{threadId:t},e)).json()}uploadFile(t,e,n,o){let r=new XMLHttpRequest,c=new Promise((a,g)=>{let m=new FormData;m.append("file",t),r.open("POST",this.buildEndpoint(`/project/file?session_id=${n}`),!0),o&&r.setRequestHeader("Authorization",this.checkToken(o)),r.upload.onprogress=function(f){if(f.lengthComputable){let y=f.loaded/f.total*100;e(y);}},r.onload=function(){if(r.status===200){let f=JSON.parse(r.responseText);a(f);}else g("Upload failed");},r.onerror=function(){g("Upload error");},r.send(m);});return {xhr:r,promise:c}}getElementUrl(t,e){let n=`?session_id=${e}`;return this.buildEndpoint(`/project/file/${t}${n}`)}getLogoEndpoint(t){return this.buildEndpoint(`/logo?theme=${t}`)}getOAuthEndpoint(t){return this.buildEndpoint(`/auth/oauth/${t}`)}};var Qe=void 0,P=createContext(new ft("http://localhost:8000","webapp"));var Kt=()=>{let s=useContext(P),t=useRecoilValue(z),e=useRecoilValue(B),n=useRecoilValue(H),o=useRecoilValue(et),r=useResetRecoilState(U),c=useResetRecoilState(et),a=useResetRecoilState(O),g=useSetRecoilState(W),m=useSetRecoilState($),f=useSetRecoilState(j),y=useSetRecoilState(q),S=useSetRecoilState(K),w=useSetRecoilState(V),F=useSetRecoilState(ot),R=useSetRecoilState(st),v=useSetRecoilState(Bt),N=useSetRecoilState(G),X=useCallback(()=>{e?.socket.emit("clear_session"),e?.socket.disconnect(),R(void 0),c(),g(void 0),f([]),y([]),S([]),w([]),F(0),r(),a(),v(void 0),N(void 0);},[e]),L=useCallback((p,h=[])=>{p.id||(p.id=v4()),p.createdAt||(p.createdAt=new Date().toISOString()),f(d=>D(d,p)),e?.socket.emit("client_message",{message:p,fileReferences:h});},[e?.socket]),J=useCallback((p,h,d,i)=>{e?.socket.emit("audio_chunk",{isStart:p,mimeType:h,elapsedTime:d,data:i});},[e?.socket]),Y=useCallback(p=>{e?.socket.emit("audio_end",{fileReferences:p});},[e?.socket]),Q=useCallback(p=>{n&&(f(h=>D(h,p)),n.callback(p));},[n]),Z=useCallback(p=>{e?.socket.emit("chat_settings_change",p);},[e?.socket]),x=useCallback(()=>{f(p=>p.map(h=>(h.streaming=!1,h))),m(!1),e?.socket.emit("stop");},[e?.socket]),E=useCallback(p=>{let h=e?.socket;if(!h)return;let d=new Promise((i,l)=>{h.once("action_response",u=>{u.status?i(u):l(u);});});return h.emit("action_call",p),d},[e?.socket]);return {uploadFile:useCallback((p,h)=>s.uploadFile(p,h,o,t),[o,t]),callAction:E,clear:X,replyMessage:Q,sendMessage:L,sendAudioChunk:J,endAudioStream:Y,stopTask:x,setIdToResume:R,updateChatSettings:Z}};var dn=()=>{let s=useRecoilValue(j),t=useRecoilValue(W);return {threadId:useRecoilValue(G),messages:s,firstInteraction:t}};var kn=()=>{let s=useContext(P),t=useRecoilValue(et),[e,n]=useRecoilState(B),o=useResetRecoilState(O),r=useSetRecoilState(W),c=useSetRecoilState($),a=useSetRecoilState(j),g=useSetRecoilState(H),m=useSetRecoilState(rt),f=useSetRecoilState(q),y=useSetRecoilState(K),S=useSetRecoilState(V),w=useSetRecoilState(U),F=useSetRecoilState(ot),[R,v]=useRecoilState(Pt),N=useRecoilValue(st),X=useSetRecoilState(G),L=useCallback(({userEnv:Q,accessToken:Z})=>{let{protocol:x,host:E,pathname:C}=new URL(s.httpEndpoint),p=`${x}//${E}`,h=C&&C!=="/"?`${C}/ws/socket.io`:"/ws/socket.io",d=ue(p,{path:h,extraHeaders:{Authorization:Z||"","X-Chainlit-Client-Type":s.type,"X-Chainlit-Session-Id":t,"X-Chainlit-Thread-Id":N||"","user-env":JSON.stringify(Q),"X-Chainlit-Chat-Profile":R?encodeURIComponent(R):""}});n(i=>(i?.socket?.removeAllListeners(),i?.socket?.close(),{socket:d})),d.on("connect",()=>{d.emit("connection_successful"),n(i=>({...i,error:!1}));}),d.on("connect_error",i=>{n(l=>({...l,error:!0}));}),d.on("task_start",()=>{c(!0);}),d.on("task_end",()=>{c(!1);}),d.on("reload",()=>{d.emit("clear_session"),window.location.reload();}),d.on("resume_thread",i=>{let l=[];for(let k of i.steps)l=D(l,k);i.metadata?.chat_profile&&v(i.metadata?.chat_profile),a(l);let u=i.elements||[];y(u.filter(k=>k.type==="tasklist")),f(u.filter(k=>["avatar","tasklist"].indexOf(k.type)===-1));}),d.on("new_message",i=>{a(l=>D(l,i));}),d.on("first_interaction",i=>{r(i.interaction),X(i.thread_id);}),d.on("update_message",i=>{a(l=>ct(l,i.id,i));}),d.on("delete_message",i=>{a(l=>St(l,i.id));}),d.on("stream_start",i=>{a(l=>D(l,i));}),d.on("stream_token",({id:i,token:l,isSequence:u,isInput:k})=>{a(gt=>It(gt,i,l,u,k));}),d.on("ask",({msg:i,spec:l},u)=>{g({spec:l,callback:u}),a(k=>D(k,i)),c(!1);}),d.on("ask_timeout",()=>{g(void 0),c(!1);}),d.on("clear_ask",()=>{g(void 0);}),d.on("call_fn",({name:i,args:l},u)=>{m({name:i,args:l,callback:u});}),d.on("clear_call_fn",()=>{m(void 0);}),d.on("call_fn_timeout",()=>{m(void 0);}),d.on("chat_settings",i=>{w(i),o();}),d.on("element",i=>{!i.url&&i.chainlitKey&&(i.url=s.getElementUrl(i.chainlitKey,t)),i.type==="tasklist"?y(l=>{let u=l.findIndex(k=>k.id===i.id);return u===-1?[...l,i]:[...l.slice(0,u),i,...l.slice(u+1)]}):f(l=>{let u=l.findIndex(k=>k.id===i.id);return u===-1?[...l,i]:[...l.slice(0,u),i,...l.slice(u+1)]});}),d.on("remove_element",i=>{f(l=>l.filter(u=>u.id!==i.id)),y(l=>l.filter(u=>u.id!==i.id));}),d.on("action",i=>{S(l=>[...l,i]);}),d.on("remove_action",i=>{S(l=>{let u=l.findIndex(k=>k.id===i.id);return u===-1?l:[...l.slice(0,u),...l.slice(u+1)]});}),d.on("token_usage",i=>{F(l=>l+i);});},[n,t,R]),J=useCallback(debounce(L,200),[L]),Y=useCallback(()=>{e?.socket&&(e.socket.removeAllListeners(),e.socket.close());},[e]);return {connect:J,disconnect:Y,session:e,sessionId:t,chatProfile:R,idToResume:N,setChatProfile:v}};var fe={enabled:!0,min_decibels:-45,initial_silence_timeout:3e3,silence_timeout:1500,max_duration:15e3,chunk_duration:1e3},Cn=(s=fe)=>{let t=useRef(null),e=useRef(!1),{sendAudioChunk:n,endAudioStream:o}=Kt(),[r,c]=useState(!1),[a,g]=useState(void 0),[m,f]=useState(!1),[y,S]=useState(void 0),[w,F]=useState(!1),R=useCallback(()=>{!r||!t.current||(e.current=!0,t.current.stop());},[r]),v=useCallback(()=>{!r||!t.current||t.current.stop();},[r]);return {startRecording:useCallback(X=>{if(r||!s)return;F(!1),S(void 0),clearTimeout(a),e.current=!1;let{min_decibels:L,silence_timeout:J,initial_silence_timeout:Y,chunk_duration:Q,max_duration:Z}=s;navigator.mediaDevices.getUserMedia({audio:!0}).then(x=>{let E=!1,C=!1,p=!0,h=null,d=Date.now(),i=new MediaRecorder(x);t.current=i,i.addEventListener("start",()=>{c(!0),d=Date.now();}),i.addEventListener("dataavailable",async T=>{if(E||(h?h=new Blob([h,T.data],{type:T.data.type}):h=new Blob([T.data],{type:T.data.type})),i.state==="inactive")return;let tt=Date.now()-d;if(tt>=Z){i.stop(),x.getTracks().forEach(Nt=>Nt.stop());return}f(C);let[Rt,me]=i.mimeType.split(";");h?(await n(p,Rt,tt,new Blob([h,T.data])),h=null):await n(p,Rt,tt,T.data),p&&(p=!1);}),i.addEventListener("stop",async()=>{c(!1),f(!1),E&&!e.current&&(F(!0),await o(X));});let l=new AudioContext,u=l.createMediaStreamSource(x),k=l.createAnalyser();k.minDecibels=L,u.connect(k);let gt=k.frequencyBinCount,_t=new Uint8Array(gt);i.start(Q);let wt=()=>{if(i.state==="inactive")return;k.getByteFrequencyData(_t);let T=_t.some(tt=>tt>0);C||(C=T),!E&&T&&(f(C),E=!0),requestAnimationFrame(wt);};wt(),setTimeout(()=>{E?g(setInterval(()=>{C?C=!1:(i.stop(),x.getTracks().forEach(T=>T.stop()));},J)):(i.stop(),x.getTracks().forEach(T=>T.stop()));},Y);}).catch(x=>{S(x.message);});},[a,r,s,n,o]),stopRecording:v,cancelRecording:R,isRecording:r,isSpeaking:m,isRecordingFinished:w,error:y}};var En=s=>{let[t,e]=useRecoilState(vt),{isAuthenticated:n}=qt(),o=navigator.language||"en-US",{data:r,error:c,isLoading:a}=dt(!t&&n?`/project/settings?language=${o}`:null,{token:s});return useEffect(()=>{r&&e(r);},[r,e]),{config:t,error:c,isLoading:a,language:o}};

export { Tt as APIBase, ft as ChainlitAPI, P as ChainlitContext, ut as ClientError, z as accessTokenState, V as actionState, D as addMessage, jt as addMessageToParent, H as askUserState, rt as callFnState, Pt as chatProfileState, mt as chatSettingsDefaultValueSelector, U as chatSettingsInputsState, O as chatSettingsValueState, vt as configState, G as currentThreadIdState, Qe as defaultChainlitContext, St as deleteMessageById, q as elementState, te as fetcher, W as firstUserInteraction, at as hasMessageById, Re as isLastMessage, $ as loadingState, j as messagesState, we as nestMessages, et as sessionIdState, B as sessionState, Bt as sideViewState, K as tasklistState, Lt as threadHistoryState, st as threadIdToResumeState, ot as tokenCountState, ct as updateMessageById, It as updateMessageContentById, dt as useApi, Cn as useAudio, qt as useAuth, be as useChatData, Kt as useChatInteract, dn as useChatMessages, kn as useChatSession, En as useConfig, Ut as userState };
//# sourceMappingURL=out.js.map
//# sourceMappingURL=index.mjs.map